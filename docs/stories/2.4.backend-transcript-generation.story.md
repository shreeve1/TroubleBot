# Story 2.4: Backend Transcript Generation Logic

## Status
Draft

## Story
**As a** developer,
**I want** the backend to receive the full chat history and use the Gemini model to condense it into a summary of key troubleshooting steps,
**so that** a smart transcript can be created.

## Acceptance Criteria
1. A new /generate-transcript endpoint is created.
2. It accepts a chat history payload.
3. It uses a summarization prompt with the Gemini API.
4. It returns a condensed text summary.

## Tasks / Subtasks
- [ ] Create transcript API endpoint (AC: 1)
  - [ ] Create apps/web/pages/api/generate-transcript.ts
  - [ ] Set up POST method handler
  - [ ] Add request validation
  - [ ] Add error handling
- [ ] Implement chat history handling (AC: 2)
  - [ ] Define chat history data structure
  - [ ] Add TypeScript interfaces
  - [ ] Validate chat history payload
  - [ ] Handle malformed requests
- [ ] Create summarization prompt (AC: 3)
  - [ ] Design prompt for troubleshooting summary
  - [ ] Configure prompt template
  - [ ] Add context about escalation purpose
  - [ ] Test prompt effectiveness
- [ ] Integrate with Gemini API (AC: 3)
  - [ ] Use existing Gemini service
  - [ ] Send chat history with prompt
  - [ ] Handle API response
  - [ ] Add error handling for API failures
- [ ] Return condensed summary (AC: 4)
  - [ ] Process Gemini response
  - [ ] Format summary text
  - [ ] Return structured JSON response
  - [ ] Add response validation
- [ ] Add comprehensive testing
  - [ ] Unit tests for endpoint
  - [ ] Integration tests with Gemini
  - [ ] Error handling tests
  - [ ] Performance testing

## Dev Notes

### Tech Stack Context
- **Backend Framework**: Next.js API Routes ~14.2.3 for serverless functions [Source: architecture/tech-stack.md]
- **Language**: TypeScript ~5.4.5 for type-safe serverless functions [Source: architecture/tech-stack.md]
- **API Style**: REST / RPC-like for API communication [Source: architecture/tech-stack.md]
- **External APIs**: Gemini API for AI processing [Source: architecture/tech-stack.md]
- **Logging**: Vercel Log Drains for serverless function logs [Source: architecture/tech-stack.md]

### Project Structure Requirements
- API routes in apps/web/pages/api/ [Source: architecture/unified-project-structure.md]
- Transcript API Endpoint component [Source: architecture/components.md]
- Gemini Service for AI processing [Source: architecture/components.md]
- No database required (stateless) [Source: architecture/tech-stack.md]

### Testing Standards
- **Backend Testing**: Jest ~29.7.0 for API testing [Source: architecture/tech-stack.md]
- **E2E Testing**: Playwright ~1.44.1 for transcript generation testing [Source: architecture/tech-stack.md]
- Multi-layered strategy following "testing pyramid" [Source: architecture/testing-strategy.md]

### File Locations
- apps/web/pages/api/generate-transcript.ts: Transcript generation endpoint
- apps/web/services/gemini.ts: Gemini API service
- apps/web/types/chat.ts: Chat history type definitions
- apps/web/utils/prompts.ts: Summarization prompt templates

### Technical Constraints
- Serverless functions must be stateless [Source: architecture/tech-stack.md]
- No persistent data storage required [Source: architecture/tech-stack.md]
- External API integration with Gemini required
- Chat history must be passed in request payload

### Previous Story Insights
- Core AI integration with Gemini established
- API client service ready for integration
- Chat interface fully functional
- Modal system for escalation ready

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-19 | 1.0 | Initial story creation | Bob (SM) |

## Dev Agent Record

### Agent Model Used
TBD

### Debug Log References
TBD

### Completion Notes List
TBD

### File List
TBD

## QA Results
TBD 